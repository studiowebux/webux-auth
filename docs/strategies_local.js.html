<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: strategies/local.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: strategies/local.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * File: local.js
 * Author: Tommy Gingras
 * Date: 2019-08-18
 * License: All rights reserved Studio Webux S.E.N.C 2015-Present
 */

"use strict";

const LocalStrategy = require("passport-local").Strategy;
const { checkPassword } = require("../lib/passwordStrategy");
const { GenerateJWT } = require("../lib/jwt");

/**
 * It initializes the local sign in and sign up functions
 * @param {Object} options The local configuration (Username and password field names)
 * @param {Object} passport The Passport Object
 * @param {Function} loginFn The Login Function (username, password, req)=>{return Promise()}
 * @param {Function} registerFn The Register Function (username, password, req)=>{return Promise()}
 * @param {Object} log The custom logging function
 */
const initLocalStrategy = (
  options,
  passport,
  loginFn,
  registerFn,
  log = console
) => {
  if (!options || typeof options !== "object") {
    return reject(
      new Error("The options parameter is required and must be an object")
    );
  }
  if (!passport || typeof passport !== "object") {
    return reject(
      new Error("The passport parameter is required and must be an object")
    );
  }
  if (!loginFn || typeof loginFn !== "function") {
    return reject(
      new Error("The loginFn parameter is required and must be a function")
    );
  }
  if (!registerFn || typeof registerFn !== "function") {
    return reject(
      new Error("The registerFn parameter is required and must be a function")
    );
  }
  if (log &amp;&amp; typeof log !== "object") {
    return reject(new Error("The log parameter must be an object"));
  }

  console.log(
    "\x1b[33m",
    "Webux-auth - Initializing the local Sign In and Sign Up Strategy",
    "\x1b[0m"
  );

  /* PASSPORT LOCAL SIGNIN */
  passport.use(
    "local-signin",
    new LocalStrategy(
      {
        usernameField: options.local.username,
        passwordField: options.local.password,
        passReqToCallback: true // allows us to pass back the entire request to the callback
      },
      (req, username, password, done) => {
        try {
          const ip =
            req.headers["x-forwarded-for"] ||
            req.connection.remoteAddress ||
            req.socket.remoteAddress ||
            (req.connection.socket
              ? req.connection.socket.remoteAddress
              : null);

          loginFn(username, password, req)
            .then(async connected => {
              connected.tokens = await GenerateJWT(
                options.jwt,
                connected,
                ip
              ).catch(e => {
                log.error(e);
                return done(e);
              });
              return done(null, connected);
            })
            .catch(e => {
              log.error(e);
              return done(e);
            });
        } catch (e) {
          log.error(e);
          return done(e);
        }
      }
    )
  );

  // /* PASSPORT LOCAL SIGNUP */
  passport.use(
    "local-signup",
    new LocalStrategy(
      {
        usernameField: options.local.username,
        passwordField: options.local.password,
        passReqToCallback: true // allows us to pass back the entire request to the callback
      },
      (req, username, password, done) => {
        try {
          // If the password strategy is enabled.
          if (
            options.local.passwordStrategy.enabled &amp;&amp;
            !checkPassword(options.local.passwordStrategy.regex, password)
          ) {
            log.error(options.local.passwordStrategy.message);
            throw new Error(options.local.passwordStrategy.message);
          }

          registerFn(username, password, req)
            .then(async registered => {
              if (options.local.autoLogonOnRegister) {
                var ip =
                  req.headers["x-forwarded-for"] ||
                  req.connection.remoteAddress ||
                  req.socket.remoteAddress ||
                  (req.connection.socket
                    ? req.connection.socket.remoteAddress
                    : null);
                registered.tokens = await GenerateJWT(
                  options.jwt,
                  registered,
                  ip
                ).catch(e => {
                  log.error(e);
                  return done(e);
                });
                return done(null, registered);
              } else {
                return done(null, registered);
              }
            })
            .catch(e => {
              log.error(e);
              return done(e);
            });
        } catch (e) {
          log.error(e);
          return done(e);
        }
      }
    )
  );
};

module.exports = { initLocalStrategy };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#activateAccount">activateAccount</a></li><li><a href="global.html#activationCode">activationCode</a></li><li><a href="global.html#checkPassword">checkPassword</a></li><li><a href="global.html#CheckToken">CheckToken</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#GenerateCode">GenerateCode</a></li><li><a href="global.html#GenerateJWT">GenerateJWT</a></li><li><a href="global.html#GenerateToken">GenerateToken</a></li><li><a href="global.html#initializeRedis">initializeRedis</a></li><li><a href="global.html#initJWTStrategy">initJWTStrategy</a></li><li><a href="global.html#initLocalStrategy">initLocalStrategy</a></li><li><a href="global.html#isAuthenticated">isAuthenticated</a></li><li><a href="global.html#lostPassword">lostPassword</a></li><li><a href="global.html#RefreshAccessToken">RefreshAccessToken</a></li><li><a href="global.html#retrievePassword">retrievePassword</a></li><li><a href="global.html#RevokeToken">RevokeToken</a></li><li><a href="global.html#saveToken">saveToken</a></li><li><a href="global.html#serializeUser">serializeUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sun Sep 01 2019 08:53:37 GMT-0400 (GMT-04:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
